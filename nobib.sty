\ProvidesExplPackage{nobib}{June 14, 2024}{0.1}{Package for simplifying referencing citations.} % see latexshort.pdf (Section 7.1.5)

\NewDocumentCommand{\create_nobib_cite_command}{mmm}{
  % #1: the reference key which also serves as the function name
  % #2: the author names
  % #3: the year of publication

  % create the integer counter
  \int_new:N \l_nobib_#1_counter_int
  \int_set:Nn \l__nobib_#1_counter_int {0}

  % create a list of labels
  \tl_new:N \l_nobib_#1_labels_tl
  
  \NewDocumentCommand{\cs:w #1 \cs_end:}{so}{
    \IfBooleanTF{##1}{ % starred version: 
      % print the citation as <author> (<year>)
      \hyperlink{#1}{#2~(#3)} 
    } { % unstarred version: 
      \IfValueTF {##2} {
        \if:w {##2 = a} {
          % print just the author name <author>   
          \hyperlink{#1}{#2}
        } \else {
          if:w {##2 = y} {
            % print just the year of publication <year>
            \hyperlink{#1}{#3}
          } \else {
            % print something weird 
            \texttt{\\\\did not specify a proper argument
              ('a' or 'y') while citing a reference}
          } \fi:
        } \fi:              
      } {
        % print the citation as <author>, <year>
        \hyperlink{#1}{#2,~#3}
      }
    }
    \int_incr:N \l_nobib_#1_counter_int
    \tl_put_right:Nn \l_nobib_#1_labels_tl {
      #1_label_ \int_use:N \l_nobib_#1_counter_int}
    \label{#1_label_ \int_use:N \l_#1_counter}
  } % of the nested NewDocumentCommand
}

\NewDocumentCommand{\create_nobib_reference_entry}{mm}{
  % #1: the reference key
  % #2: the reference text that appears in the .tex document
  \int_compare:nNnTF {\l_nobib_#1_counter_int} > {0} {
    % print the reference text
    \hypertarget{#1}{#2}

    \int_compare:nNnTF {\l_nobib_#1_counter_int} = {1} {
      % the reference has been cited exactly once
      \seq_pop_left:NN \l_nobib_#1_labels_tl \l_tempa_tl 
      \small{(Cited on page \pageref{\tl_use:N \l_tempa_tl}.)}
    } {
      \int_compare:nNnTF {\l_nobib_#1_counter_int} = {2} {
        % the reference has been cited twice
        \seq_pop_left:NN \l_nobib_#1_labels_tl \l_tempa_tl
        \seq_pop_left:NN \l_nobib_#1_labels_tl \l_tempb_tl 
        \small{(Cited on pages \pageref{\tl_use:N \l_tempa_tl}
          and \pageref{\tl_use:N \l_tempb_tl}.)}
      } {
        % the reference has been cited three or more times
        \small{(Cited on pages }
        \int_set:Nn \l_tempa_int {\l_nobib_#1_counter_int}
        \int_do_while:nNnn {\l_tempa_int} > {1} {
          % repeat this for all but the last reference
          \seq_pop_left:NN \l_nobib_#1_labels_tl \l_tempa_tl
          \small{\pageref{\tl_use:N \l_tempa_tl}, }
          \int_decr:N \l_tempa_int
        }
        \seq_pop_left:NN \l_nobib_#1_labels_tl \l_tempa_tl
        \small{and \pageref{\tl_use:N \l_tempa_tl}.)}
      }
    }
  } {
    % if the reference is not cited even once in the paper, do not include it
  } 
}
